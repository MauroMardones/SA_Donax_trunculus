---
title: "![](IEO-logo.jpg){width=5cm}"
output:
  bookdown::pdf_document2
    includes:
      before_body: titulo.sty
    keep_tex: yes
    number_sections: no
    toc: true
    toc_depth: 3
bibliography: Donax.bib
csl: apa.csl
link-citations: yes
linkcolor: blue
indent: no
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhf{}
- \lfoot[\thepage]{}
- \rfoot[]{\thepage}
- \fontsize{12}{20}
- \selectfont
---

\pagebreak



# 1. ANTECEDENTES

La idea de este documento es la implementación metodológica de la evaluación de stock mediante un modelo integrado con datos en talla y dinamica en edad implemetnado en Stock Synthesis (SS3) (v.3.30.21) [@Methot2013; @Methot2023] para la zona del Golfo de Cádiz, España, como parte de la asesoría científica que lleva a cabo el Instituto Español de Oceanografía (IEO) realizado por el grupo de investigadores asociados al proyecto FEMP 04.


# 2. METODOLOGÍA

El flujo de trabajo asociado a la modelación de stock, tanto componentes como fuentes de datos está representado de forma genérica en el siguiente diagrama de flujo (Figura \ref{fig:esq});


```{r esq, echo=FALSE, out.width = "100%", fig.align='center', fig.cap="\\label{fig:esq}Esquema de modelación de coquina"}
knitr::include_graphics("FIg/Diagrama_Modelo.png")
```

```{r setup1, echo=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align = 'center',
                      fig.pos = "H",
                      dev = 'jpeg',
                      dpi = 300)
#XQuartz is a mess, put this in your onload to default to cairo instead
options(bitmapType = "cairo") 
# (https://github.com/tidyverse/ggplot2/issues/2655)
# Lo mapas se hacen mas rapido
```

```{r lib, eval=TRUE, echo=F}
# install.packages("devtools")
# install.packages("caTools")
# library("caTools")
# # install.packages("r4ss")
paquetes <- c("stringr", 
              "tidyverse", 
              "kableExtra","ggplot2",
              "ggthemes",
               "patchwork",
              "dplyr","reshape","here","r4ss",
              "zoo","ss3diags","pdftools",
              "forcats","ggpubr")
lapply(paquetes, require, character.only = TRUE)
```


```{r eval=FALSE, echo=FALSE}
dir01<-here("s01")# Modelo solo con 
dir1<-here("s1")# test 1
dir2<-here("s2") # test2 
dir3<-here("s3") # 
dir4<-here("s4") # 
dir5<-here("s5") # 
```


```{r}
# leo archivos para plotear y hacer tablas
start1 <- SS_readstarter(file = file.path(dir1,
                                               "starter.ss"),
                              verbose = FALSE)
# note the data and control file names can vary, so are determined from the 
# starter file.
dat1 <- SS_readdat(file = file.path(dir1, start$datfile),
                        verbose = FALSE)
# Read in ctl file. Note that the data fileR object is needed so that SS_readctl
# assumes the correct data structure
ctl1 <- SS_readctl(file = file.path(dir1,
                                    start$ctlfil),
                        verbose = FALSE,
                        use_datlist = TRUE, 
                   datlist = dat1)
fore1 <- r4ss::SS_readforecast(file = file.path(dir1, 
                                                "forecast.ss"),
                              verbose = FALSE)
# can also read in wtatage.ss for an empirical wt at age model using
# r4ss::SS_readwtatage()
```



\pagebreak

## 2.1. Datos utilizados

Los datos analizados que formaron parte de los inputs del modelo fueron clasificados de acuerdo a su origen. A saber;

a.  Desembarque  artesanal del período (2004-2024), provenientes de las estadisticas oficiales de [IDAPES](https://www.juntadeandalucia.es/agriculturaypesca/idapes/servlet/FrontController) asociados al sector de marisquería del Parque Doñana y cercanías. Cabe señalar que en esta pesquería aun no se realizan procesos de corrección de desembarques y que serán propuestos como escenarios de modelación.


b.  Información de los programas de monitoreo poblacional y comercial que lleva a cabo el IEO desee el año 2013. En este monitoreo se recopila información biológica, pesquera y ambiental. 

c . Información relativa a los parámetros de historia de vida de la coquina a nivel europeo y local. Esta información está contenida en artículos científicos y reportes que fueron compilados con el fin de parametrizar los modelos de evaluación.

Toda esta información, codigos fuente, bases de datos y Analisis Exploratorio de Datos puede ser encontrado en el siguiente enlace: [Data coquina](https://mauromardones.github.io/EDA_Donux_trunculus_2023/). La cobertura temporal de las fuentes de datos varia de acuerdo a la disponibilidad asociada al programa y fuente (Figura \ref{fig:data});


```{r data, echo=FALSE, out.width = "80%", fig.align='center', fig.cap="\\label{fig:data}Cobertura temporal de las distintas fuentes de datos usadas en el modelo implementado en SS3 para coquina"}
knitr::include_graphics("s1/plots/data_plot.png")
```
La estimación de la biomasa desovante se realizó a inicios de año, mientras que el reclutamiento se consideró como un evento doble que ocurre hacia junio y fines de año.  En el proceso de estimación del reclutamiento, se incorporó una relación stock-recluta difusa (steepness 0.7), y las variaciones en el reclutamiento se modelaron como desviaciones del reclutamiento virginal `R0`, asumiendo 2004 como año inicial (Tabla \ref{Tab1}).

La mortalidad por pesca se estimó como el promedio simple de la FFF de las clases de edad 1 y 2, lo que en el modelo corresponde a la opción 5 del método `F híbrido` recomendado en SS3 [@Methot2013]. Se asume que la densidad es un proxi de las biomasas estimadas [@Caddy2004] en los muestreos poblacionales y que son proporcionales a la biomasa vulnerable de la población, con la capturabilidad (`q`) estimada en el modelo. Los parámetros qqq fueron estimados a patir de parámetros iniciales especificados en la Tabla \ref{Tab1} para los datos del monitoreo poblacional , así como del comercial. Todos los patrones de selectividad, que relacionan las composiciones de tallas observadas de la flota comercial y poblacional con la dinámica, fueron estimados mediante una función logística. Los parámetros `p1` (talla en la inflexión de la curva) y `p2` (selección al 95%) son estimados por el modelo a partir de los valores iniciales especificados en la Tabla \ref{Tab1}.

```{r}
 parbio<-ctl1$MG_parms[1:10,c(1:3,7)]
 row.names( parbio)<-c("Nat M",
                       "Lmin", 
                       "Lmax",
                       "VonBert K",
                       "CV young",
                       "CV old", 
                       "Wt a", 
                       "Wt b",
                       "L50%", 
                       "Mat slope")

 SRpar<-ctl1$SR_parms[1:5,c(1:3,7)]
 Qpar<-ctl1$Q_parms[1:2,c(1:3,7)]
 Selpar<-ctl1$size_selex_parms[1:4,c(1:3,7)]
 parInit<-rbind(parbio,SRpar,Qpar,Selpar)

parInit %>%
  kbl(booktabs = T,
      format = "latex",
      position="ht!",
      align="c",
    caption = "\\label{Tab1}Parámetros de entrada al modelo inicial SS3 de coquina (S1). Cada línea de parámetro contiene un valor mínimo (LO), máximo (HI) e inicial (INIT). Si la fase (PHASE) para el parámetro es negativa, el parámetro es fijo de entrada") %>%
  kable_paper("hover", 
              full_width = F)%>%
  kable_styling(latex_options = c("striped",
                                  "condensed"),
                full_width = FALSE,
                font_size=9)%>% 
  pack_rows(index = c("Mortalidad natural" = 1,
                        "Crecimiento"= 5,
                        "Relación longitud-peso" = 2,
                        "Ojiva de madurez"=2,
                        "Relación stock-recluta"=5,
                        "Capturabilidad"=2,
                        "Selectividad"=4))

```

## 2.2. Modelo de la dinámica poblacional

El modelo de dinámica poblacional de la coquina, corresponde a un enfoque de evaluación del tipo estadístico con estructura de edad, donde la dinámica progresa avanzando en el tiempo t, y las capturas son causantes de la mortalidad por pesca F, la mortalidad natural es constante `M = 0.99` (\ref{Tab1}). La relación entre la población y las capturas responde a la base de la ecuación de Baranov, y se consideran para el modelo y estimaciones el rango de edad entre 1 a 5+ (años). Sin embargo, las estimaciones del modelo tienen su origen en la edad cero sobre la base de una condición inicial estado estable. La dinámica esta modelada por un reclutamiento tipo Beverton y Holt.


De manera sencilla, el fondo de SS3 es su modelo de dinámica poblacional, el cual se representa la dinámica de las poblaciones de coquina a lo largo del tiempo. Este modelo incorpora parámetros biológicos clave como tasas de crecimiento, tasas de mortalidad, reclutamiento y biomasa desovante. Normalmente, el modelo se formula utilizando ecuaciones matemáticas que describen cómo estos parámetros interactúan para determinar la abundancia y distribución de coquina en el área de estudio.

La ecuación de estado de creciiento poblacional de coquina puede representarse como:

\[
N_t = N_{t-1} \cdot e^{(r - M)} + R
\]

Where:
- \(N_t\) es abundancia de coquina en el tiempo \(t\).
- \(N_{t-1}\) abundancia de krill en pasos de tiempo previos.
- \(r\) es la tasa de crecimiento poblacional intrinseca.
- \(M\) es la tasa de mortalidad natural.
- \(R\) es el reclutamiento de nuevos individuos al stock.

Esta ecuación representa la dinámica básica de la población de coquina, con la abundancia cambiando con el tiempo debido al crecimiento, la mortalidad y el reclutamiento. Junto a esta ecuación, otros submodelos asociados como crecimiento individual, selectividad, madurez, captura a la edad entre otros estan dentro del proceso de estimación de SS3 [@Methot2023] 


El modelo de evaluación fue configurados utilizando Stock Synthesis (SS3 de aqui en mas)(<https://vlab.noaa.gov/web/stock-synthesis>), que es un modelo de evaluación de stock edad y talla estrucuturado, en la clase de modelo denominado *Modelo de análisis integrado*. SS tiene un sub-modelo poblacional de stock que simula crecimiento, madurez, fecundidad, reclutamiento, movimiento, y procesos de mortalidad, y sub-modelos de observation y valores esperados para diferentes tipos de datos. El modelo es codificado en C++ con parámetros de estimación activados por diferenciación automática (ADMB) [@Methot2013]. El análisis de resultados y salidas emplea herramientas de R e interfase gráfica de la librería `r4ss` (<https://github.com/r4ss/r4ss>) [@Taylor2019] y`ss3diags`  [@Henning2023].



## 2.3. Escenarios

Para avanzar en la implenteación metodológica, y considerando las fuentes de incertidumbre asociadas a la modelación de stock de coquina, se establecen una serie de modelos alternativos basados en piezas de datos y subreporte de los niveles de desembarque. Esto dado los niveles de furtivismo que no son reflejados en las cifras oficiales. Estos escenarios estan descritos en la Tabla \ref{Tab2}..


```{r}
esc<-c("S01","S1","S2","S3","S4","S5")

descripcion<-c("Solo Desembarque e Índice",
               "Flota comercial y poblacional, Desembarque, Índice, Composisiones de Tallas",
               "S1 + Vector Desembarques desde 1990 asumido en 250 por año",
               "S1 + Vector desembarques ponderado por 1.5",
               "S1 + Vector desembarques ponderado por 2",
               "S1 + Vector desembarques ponderado por 2.5")

ESC1<-cbind(esc,descripcion)

ESC1 %>% kbl(booktabs = T,
             format = "latex",
             position="h!",
             align="l",
        col.names = linebreak(c('Escenarios',
                                "Descripción"),
                              align="c"),
        caption = "\\label{Tab2}Descripción de los escenarios alternativos al modelo base inicial (S1).") %>%
  kable_paper("hover", 
              full_width = F) %>% 
    kable_styling(latex_options = c("striped", 
                                    "condensed"),
                  full_width = FALSE,
                  font_size=10)
```




\pagebreak

# 3. RESULTADOS

Instalación de las librerias necesarias


## 3.1. Principales salidas de modelos y variables poblacionales


Los componentes de verosimilitud, además de los análisis de residuales permiten identificar entre los bloques de modelos cuales de las configuraciones presenta un desempeño adecuado
en términos estadísticos de ajuste a la información. 

Estos modelos, son los seleccionados para presentar en sus principales salidas para fines informativos de indicadores, puntos biológicos de referencia y estimaciones poblacionales.


```{r eval=FALSE, message=F, include=FALSE}
# Lista de directorios para correro tordos juntos
directorios <- c("s01", 
                 "s1", 
                 "s2",
                 "s3",
                 "s4",
                 "s5",
                 "s6",
                 "s7")  # Agrega aquí todos los nombres de las carpetas que deseas procesar

# Bucle para ejecutar el código en cada directorio
for (dir in directorios) {
  r4ss::run(
    dir = dir,
    exe = "ss_osx",
    skipfinished = FALSE,
    show_in_console = TRUE
  )
}
# Considerar que al correr el modelo dentro de cada `chunk` se cambia el directorio.
```



```{r eval= F, message=FALSE, warning=FALSE, include=FALSE}
# Corro escenario por separado 
r4ss::run(
  dir = dir1,
  exe = "ss_osx",
  skipfinished = FALSE, # TRUE will skip running if Report.sso present
  show_in_console = TRUE # change to true to watch the output go past
)
```


```{r eval= F, message=FALSE, warning=FALSE, include=FALSE}
#Leo las salidas del modelo seleccionado. 

dir1<-here("s1")
base.model1 <- SS_output(dir=dir1,
                         covar=T,
                         forecast=T)

SS_plots(base.model1,
         uncertainty=T,
         datplot = T, 
         png=T, 
         aalresids = F,
         btarg=0.40,
         minbthresh=0.20, 
         forecast=T)

```

Data disponible para este escenario. Espinel es la serie mas consistente del conjunto de datos.

```{r}
SSplotData(base.model1, subplots = 2, 
           fleetnames = c("COMERCIAL", "POBLACIONAL"),
           fleetcol = c("#2c7fb8","#31a354"),
           maxsize = 0.5)
```
Read in Stock Synthesis files

Stock Synthesis files can be read in as list objects in R using the SS_read*() functions.
```{r}
start <- r4ss::SS_readstarter(file = file.path(new_mod_path, "starter.ss"), 
                              verbose = FALSE)
# note the data and control file names can vary, so are determined from the 
# starter file.
dat <- r4ss::SS_readdat(file = file.path(new_mod_path, start$datfile),
                        verbose = FALSE)
# Read in ctl file. Note that the data fileR object is needed so that SS_readctl
# assumes the correct data structure
ctl <- r4ss::SS_readctl(file = file.path(dir3, start$ctlfil),
                        verbose = FALSE,
                        use_datlist = TRUE, datlist = dat)
fore <- r4ss::SS_readforecast(file = file.path(dir3, "forecast.ss"),
                              verbose = FALSE)
# can also read in wtatage.ss for an empirical wt at age model using
# r4ss::SS_readwtatage()
```


```{r}
start <- r4ss::SS_readstarter(file = file.path(dir3, "starter.SS"), 
                              verbose = FALSE)
dat <- r4ss::SS_readdat(file = file.path(dir3, start$datfile),
                        verbose = FALSE)
ctl <- r4ss::SS_readctl(file = file.path(dir3, start$ctlfil),
                        verbose = FALSE,
                        use_datlist = TRUE, datlist = dat)
class(dat)
dat$lencomp

```



```{r}
parbio <-ctl$MG_parms

kbl(parbio, booktabs = T,format = "latex",
    caption = "\\label{t1}Parámetros biológicos") %>%
    kable_styling(latex_options = c("striped",
                                  "condensed","scale_down"),
                full_width = FALSE,font_size=8) %>% 
  landscape()
```


```{r}
SSplotCatch(base.model3, subplots = 2, fleetnames = c("Espinel", "Enmalle"),
            fleetcols = c(2,5), forecastplot = T)
```


Respecto a los valores y parametros biologicos modelados, los siguientes graficos identifican los estimadores puntuales del recurso

```{r}
SSplotBiology(base.model1, subplots =1, labels = c("Length (cm)", "Age (yr)", "Maturity", "Mean weight (kg) in last year",
    "Spawning output", "Length (cm, beginning of the year)", "Natural mortality",
    "Female weight (kg)", "Female length (cm)", "Fecundity", "Default fecundity label",
    "Year", "Hermaphroditism transition rate", "Fraction females by age at equilibrium"),
 )
```

aporte de las cohortes por año para las capturas.
```{r}
SSplotCohortCatch(base.model3, subplots = 1)
```

\quad

AJuste de tallas por flota
```{r}
SSplotComps(base.model3, subplots = 1)
```

Otros plots
```{r}
SSplotDynamicB0(base.model3, uncertainty = F)
#SSplotSPR(base.model3)
SSplotPars(base.model3)

```

Salida de las biomasas con las dos flotas


```{r}
SSplotTimeseries(base.model3, subplot = 1)
```


### 3.1.4. Mod s4 (Flotas artesanal espinel)

Este modelo está implementado pero falta resolver los niveles de convergencia y los warning. Este modelo ha sido el implementado en @Reineta2022


```{r eval=F, message=FALSE, warning=FALSE, include=FALSE}
dir4<-here("s4")

r4ss::run_SS_models(dirvec = dir4, model = './ss_osx', 
                    skipfinished = FALSE)
```


```{r echo=F, include=F, message=F}
#Leo las salidas del modelo seleccionado. 

dir4<-here("s4")
base.model4 <- SS_output(dir=dir4,covar=F,forecast=F)
```

```{r}
SSplotData(base.model4, fleetcol = 5, subplot = 2)

```
```{r eval=FALSE}
p1 <-SS_readdat_3.30("s4/ss.dat", verbose = TRUE, echoall = FALSE,section = NULL)

startfile <- SS_readstarter("s4/starter.ss_new")
```


Respecto a los valores y parametros biologicos modelados, los siguientes graficos identifican los estimadores puntuales del recurso

```{r}
SSplotBiology(base.model4,  subplot=1, labels = c("Length (cm)", "Age (yr)", "Maturity", "Mean weight (kg) in last year",
    "Spawning output", "Length (cm, beginning of the year)", "Natural mortality",
    "Female weight (kg)", "Female length (cm)", "Fecundity", "Default fecundity label",
    "Year", "Hermaphroditism transition rate", "Fraction females by age at equilibrium"),
 )
```

ahora miro los ajustes de las tallas por flota
```{r}
SSplotCohortCatch(base.model4, subplots = 2)
```

```{r}
SSplotComps(base.model4, subplots = 1)
SSplotDynamicB0(base.model4, uncertainty = F)
SSplotSPR(base.model4)
SSplotPars(base.model4)
```

```{r}
SSplotTimeseries(base.model4, subplot = 1)

```

### 3.1.5. Mod s5 (Modelo Jerarquico. Indice Biomasa modelo Catch Based [@Zhou2009])

Modelo no implemetado a la fecha


```{r eval=F, message=FALSE, warning=FALSE, include=FALSE}
dir5<-here("s5")

r4ss::run_SS_models(dirvec = dir5, model = './ss_osx', 
                    skipfinished = FALSE)
```





\pagebreak

# 4. COMPARACION DE MODELOS

(En desarrollo)

```{r eval=FALSE}
#PLOT labels, name of each model run
legend.labels <- c('dir1','dir2','dir3', 'dir4')

#read in all model runs
#note if cover=T you need a hessian; if covar=F you do not need a hessian
biglist <- SSgetoutput(keyvec = NULL, dirvec = c(SSdir1,SSdir2,SSdir3),	getcovar = F)

#create summary of model runs from list above
summaryoutput <- SSsummarize(biglist)

SSplotComparisons(summaryoutput, subplots = 1:20, plot = TRUE,
                  print = T, endyrvec = "default", indexfleets = NULL, indexUncertainty = FALSE,
                  indexQlabel = TRUE, indexQdigits = 4, indexSEvec = "default",
                  indexPlotEach = FALSE, labels = c("Year", "Spawning biomass (t)",
                                                    "Relative spawning biomass", "Age-0 recruits (1,000s)",
                                                    "Recruitment deviations", "Index", "Log index", "1 - SPR", "Density",
                                                    "Management target", "Minimum stock size threshold", "Spawning output",
                                                    "Harvest rate"), col = NULL, shadecol = NULL, pch = NULL,
                  lty = 1, lwd = 2, spacepoints = 10, staggerpoints = 1,
                  initpoint = 0, tickEndYr = TRUE, shadeForecast = TRUE,
                  xlim = "default", ylimAdj = 1, xaxs = "r", yaxs = "r",
                  type = "o", uncertainty = TRUE, shadealpha = 0.1, legend = TRUE,
                  legendlabels = "default", legendloc = "topright",
                  legendorder = "default", legendncol = 1, sprtarg = NULL,
                  btarg = NULL, minbthresh = NULL, pwidth = 6.5, pheight = 5,
                  punits = "in", res = 300, ptsize = 10, cex.main = 1,
                  plotdir = "C:\\Users\\mauricio.mardones\\Documents\\IFOP\\Loco_Assessment_AMERB\\SA_Loco", 
                  filenameprefix = "", densitynames = c("SSB_Virgin","R0"), 
                  densityxlabs = "default", densityscalex = 1,
                  densityscaley = 1, densityadjust = 1, densitysymbols = TRUE,
                  densitytails = TRUE, densitymiddle = FALSE, densitylwd = 1,
                  fix0 = TRUE, new = TRUE, add = FALSE, 
                  par = list(mar = c(5, 4, 1, 1) + 0.1), 
                  verbose = TRUE, mcmcVec = FALSE,
                  show_equilibrium = TRUE)
```

Tablas comparativas


```{r eval=F}
SStableComparisons(summaryoutput,
                   likenames = c("TOTAL", "Survey", "Length_comp", "Age_comp", "priors",
                                 "Size_at_age"), names = c("Recr_Virgin", "R0", "steep", "NatM",
                                                           "L_at_Amax", "VonBert_K", "SSB_Virg", "Bratio_2017", "SPRratio_2016"),
                   digits = NULL, modelnames = "default", csv = FALSE,
                   csvdir = "C:\\Users\\mauricio.mardones\\Documents\\IFOP\\Loco_Assessment_AMERB\\SA_Loco",
                   csvfile = "parameter_comparison_table.csv", verbose = TRUE,
                   mcmc = FALSE)
```

\pagebreak
# 5. DIAGNÓSTICO

```{r eval=F}

#do retrospective model runs
SS_doRetro(dir4, '', newsubdir = "retrospectives",
           subdirstart = "retro", years = 0:-5, overwrite = TRUE, exefile = "ss",
           extras = "-nox -nohess", intern = FALSE, CallType = "system",
           RemoveBlocks = FALSE)
retroModels <- SSgetoutput(dirvec=file.path(dir4, "retrospectives",paste("retro",0:-5,sep="")))
retroSummary <- SSsummarize(retroModels)


endyrvec <- retroSummary$endyrs + 0:-5
SSplotComparisons(retroSummary, endyrvec=endyrvec, legendlabels=paste("Data",0:-5,"years"),
                  plotdir='month\\',plot=TRUE,print=T)
TableCompare <- SStableComparisons(retroSummary,likenames=like, names=names, 
                                   modelnames=c('B','-1','-2','-3','-4','-5'), csv=TRUE, csvfile="RetroRuns.csv",verbose=FALSE)

```


Dado que la variabilidad del índice rho de Mohn depende de la historia de vida (usualmente
mayor para especies de vida corta) y que el estadístico parece insensible a F, Hurtado-Ferro et al. (2015)
propusieron que el patrón retrospectivo de alguna de las variables biológico-pesqueras indicadas es
preocupante si los valores del índice Mohn’s rho son superiores a 0,20 o inferiores a -0,15 para especies
de vida larga, o superiores a 0,30 o inferiores a -0,22 para especies de vida corta.


\pagebreak

# 6. PROGRESO

- S1. Falta correr modelo implementado

- s2. Falta correr data solo con enmalle. NO se si esto sea nenecsario para propositos de evaluación dado que este set de datos no se utiliza por si solo

- s3. Mejorar ajustes de tallas y revisar outputs de variables poblacionales.

- s4. Modelo solo de espinel. OK.

- s5. Modelo con indice de biomasas de Zhou no implemetnado.

\pagebreak

# 6. REFERENCIAS
